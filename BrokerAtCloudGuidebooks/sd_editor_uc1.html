<!DOCTYPE html>
<html lang="en" prefix="rdf: http://www.w3.org/1999/02/22-rdf-syntax-ns#
              rdfs: http://www.w3.org/2000/01/rdf-schema#
              foaf: http://xmlns.com/foaf/0.1/
              owl: http://www.w3.org/2002/07/owl#
              dcterms: http://purl.org/dc/terms/
              gr: http://purl.org/goodrelations/v1#
              usdl-core: http://www.linked-usdl.org/ns/usdl-core#

              vcard: http://www.w3.org/2006/vcard/ns#
              xsd: http://www.w3.org/2001/XMLSchema#">

<head>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <style>
        .droptarget {
            float: down;
            <!-- width: 400px;
            --> height: 50px;
            margin: 5px;
            padding: 5px;
            font-size: 14pt;
            border: 5px solid #ffaaaa;
            background-color: lightgrey;
        }
    </style>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge;chrome=1" />
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <title>USDL Service Description Editor for Broker Policies with instantiated profiles</title>

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="viewport" content="width=980" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <link rel="shortcut icon" href="images/usdl-solo.ico" />
    <link rel="apple-touch-icon" href="images/splash_about.png" />
    <!--link rel="stylesheet" href="jquery/css/smoothness/jquery-ui-1.8.6.custom.css" /-->
    <!--link rel="stylesheet" href="css/jquery-ui-timepicker-addon.css" /-->
    <!--link rel="stylesheet" href="css/jquery.jgrowl.css" type="text/css"/-->
    <!--link rel="stylesheet" href="css/ui.sa.css" /-->
    <!--link rel="stylesheet" href="css/sapUiUx3.css" />
        <link rel="stylesheet" href="css/infovis.css" /-->
    <!-- Bootstrap -->
    <link href="bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap theme -->
    <link href="bower_components/bootstrap/dist/css/bootstrap-theme.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="template.css" rel="stylesheet">


    <!--script type="text/javascript" src="jquery/js/jquery-1.6.2.min.js" ></script-->
    <script type="text/javascript" src="bower_components/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <!--script type="text/javascript" src="jquery/js/jquery-ui-1.8.16.custom.min.js"></script-->

    <!--script type="text/javascript" src="js/jquery-ui-timepicker-addon.js"></script-->
    <script type="text/javascript" src="js/jquery.editable-1.3.3.js"></script>
    <script type="text/javascript" src="js/jquery.livequery.js"></script>
    <script type="text/javascript" src="js/jquery.clicknscroll.v1.0.js"></script>
    <script type="text/javascript" src="js/jquery.sa.js"></script>
    <script type="text/javascript" src="js/jquery.cookie.js"></script>
    <script type="text/javascript" src="js/mime.js"></script>
    <script type="text/javascript" src="js/slidedeck.js"></script>
    <!--script type="text/javascript" src="js/jquery.jgrowl_minimized.js"></script-->
    <script type="text/javascript" src="js/Math.uuid.js"></script>
    <script type="text/javascript" src="js/base64.js"></script>
    <!--script type="text/javascript" src="js/jit-yc.js"></script-->
    <script type="text/javascript" src="rdfquery/jquery.json.js"></script>
    <script type="text/javascript" src="rdfquery/jquery.uri.js"></script>
    <script type="text/javascript" src="rdfquery/jquery.xmlns.js"></script>
    <script type="text/javascript" src="rdfquery/jquery.curie.js"></script>
    <script type="text/javascript" src="rdfquery/jquery.datatype.js"></script>
    <script type="text/javascript" src="rdfquery/jquery.rdf.js"></script>
    <script type="text/javascript" src="rdfquery/jquery.rdfa.js"></script>
    <script type="text/javascript" src="rdfquery/jquery.rdf.json.js"></script>
    <script type="text/javascript" src="rdfquery/jquery.rdf.xml.js"></script>
    <script type="text/javascript" src="rdfquery/jquery.rdf.turtle.js"></script>
    <!--<script type="text/javascript" src="js/usdl.editor.cas.js"></script> -->
    <script type="text/javascript">
        var kb;

        function storeSD() {
            var sp_namespace = document.getElementById("sp_namespace").value;
            var sd_namespace = document.getElementById("sd_namespace").value;
            var kb_sd = $.rdf()
                .base(sd_namespace)
                .prefix('foaf', 'http://xmlns.com/foaf/0.1/')
                .prefix('rdf', 'http://www.w3.org/1999/02/22-rdf-syntax-ns#')
                .prefix('rdfs', 'http://www.w3.org/2000/01/rdf-schema#')
                .prefix('owl', 'http://www.w3.org/2002/07/owl#')
                .prefix('dcterms', 'http://purl.org/dc/terms/')
                .prefix('usdl-core', 'http://www.linked-usdl.org/ns/usdl-core#')
                .prefix('usdl-core-cb', 'http://www.linked-usdl.org/ns/usdl-core/cloud-broker#')
                .prefix('usdl-sla', 'http://www.linked-usdl.org/ns/usdl-sla#')
                .prefix('usdl-sla-cb', 'http://www.linked-usdl.org/ns/usdl-core/cloud-broker-sla#')
                .prefix('usdl-business-roles', 'http://www.linked-usdl.org/ns/usdl-business-roles#')
                .prefix('blueprint', 'http://bizweb.sap.com/TR/blueprint#')
                .prefix('vcard', 'http://www.w3.org/2006/vcard/ns#')
                .prefix('xsd', 'http://www.w3.org/2001/XMLSchema#')
                .prefix('ctag', 'http://commontag.org/ns#')
                .prefix('org', 'http://www.w3.org/ns/org#')
                .prefix('skos', 'http://www.w3.org/2004/02/skos/core#')
                .prefix('time', 'http://www.w3.org/2006/time#')
                .prefix('gr', 'http://purl.org/goodrelations/v1#')
                .prefix('doap', 'http://usefulinc.com/ns/doap#')
                .prefix('bp', document.kb.databank.baseURI)
                .prefix('sp', sp_namespace + "#")
                .prefix('sd', sd_namespace + "#")
                // Create the business entity of the service provider
                .add("sp:" + document.getElementById("sp_business_entity").value + " a gr:BusinessEntity .")
                .add('sp:' + document.getElementById("sp_business_entity").value + ' gr:legalName ' + '"' + document.getElementById("sp_legal_name").value + '"' + ' .')
                // Create the entity involvement instance and bind it to the service provider business entity
                .add("sd:" + document.getElementById("sp_business_entity").value + "EntityInvolvement" + " a usdl-core:EntityInvolvement .")
                .add("sd:" + document.getElementById("sp_business_entity").value + "EntityInvolvement" + " usdl-core:withBusinessRole usdl-business-roles:provider .")
                .add("sd:" + document.getElementById("sp_business_entity").value + "EntityInvolvement" + " usdl-core:ofBusinessEntity sp:" + document.getElementById("sp_business_entity").value + " .")
                // Create the service instance
                .add("sd:" + document.getElementById("sd").value + " a usdl-core:Service .")
                .add("sd:" + document.getElementById("sd").value + " dcterms:creator sp:" + document.getElementById("sp_business_entity").value + " .")
                .add("sd:" + document.getElementById("sd").value + " usdl-core:hasEntityInvolvement sd:" + document.getElementById("sp_business_entity").value + "EntityInvolvement .")
                .add("sd:" + document.getElementById("sd").value + " usdl-core-cb:hasServiceModel sd:" + document.getElementById("sd_model").value + " .")
                .add("sd:" + document.getElementById("sd").value + " usdl-core-cb:validFrom \"" + document.getElementById("sd_validFrom").value + "\"^^xsd:date .")
            if (document.getElementById("sd_validThrough").value != "") {
                kb_sd.add("sd:" + document.getElementById("sd").value + ' usdl-core-cb:validThrough ' + '"' + document.getElementById("sd_validThrough").value + '"^^xsd:date .');
            }
           // Create successor of and recommendation deprecation, if any.
            // Deprecation recommendation will not be created if there is no successor of even if a value is provided!
            if (document.getElementById("sd_successorOf").value != "") {
                kb_sd.add("sd:" + document.getElementById("sd").value + " gr:successorOf <" + document.getElementById("sd_successorOf").value + "> .");
                if (document.getElementById("sd_deprecationRecommendation").value != "") {
                    kb_sd.add("sd:" + document.getElementById("sd").value + ' usdl-core-cb:deprecationRecommendationTimePointSD ' + '"' + document.getElementById("sd_deprecationRecommendation").value + '"^^xsd:date .');
                }
            }

            
            // Create the service model instance
            kb_sd.add("sd:" + document.getElementById("sd_model").value + " a bp:" + document.getElementById("servicemodel_class").value + " .")
                .add("sd:" + document.getElementById("sd_model").value + " gr:isVariantOf bp:" + document.getElementById("servicemodel").value + " .")
                // Assign the selected profile instance to the service model
                .add("sd:" + document.getElementById("sd_model").value + " bp:" + document.getElementById("slp_class").value + " <" + document.getElementById("slp").value + "> .");
            if (document.getElementById("sd_dependsOn").value != "") {
                document.getElementById("sd_dependsOn").value.split(" ").forEach(function (dep) {
                    kb_sd.add("sd:" + document.getElementById("sd").value + " usdl-core-cb:dependsOn <" + dep + "> .");
                });
            }
            // Add the chosen classification concepts to the service model
            kb_sd = addClassificationConcepts(kb_sd);
            // Dump the kb with the service description to a turtle format and show it in a separate window.

            kb_sd = storeSLsFromPanel(kb_sd);

            var dmp = kb_sd.databank.dump({
                format: 'text/turtle',
                indent: true,
                serialize: true
            })
            var uueFile = Base64.encode(dmp)
            var uri = 'data:text/turtle;base64,' + encodeURIComponent(uueFile)
            window.open(uri)
        }

        //output
        function storeSLsFromPanel(kb) {
            var currentSLs = getSLsFromPanel(document.getElementById('optionalInstancePanel'));

            currentSLs.qualitative.forEach(function (currentQualInstance) {
                //quickfix: bp:hasXYZ -> bp:hasSLXYZ
                kb.add("<" + document.getElementById("sd_model").value + "> bp:has" + currentQualInstance.type + " bp:" + currentQualInstance.value);
            });
            currentSLs.quantitative.forEach(function (currentQuantInstance) {
                //quickfix: bp:hasXYZ -> bp:hasSLXYZ
                kb.add("<" + document.getElementById("sd_model").value + "> bp:has" + currentQuantInstance.quant_value_typeNG + " bp:" + currentQuantInstance.quant_value_instNG);

                kb.add("bp:" + currentQuantInstance.quant_value_instNG + " a bp:" + currentQuantInstance.quant_value_typeNG + " .");
                kb.add("bp:" + currentQuantInstance.quant_value_instNG + ' rdfs:label "' + currentQuantInstance.instanceDescriptionNG + '"^^xsd:string .');
                kb.add("bp:" + currentQuantInstance.quant_value_instNG + ' gr:hasUnitOfMeasurement "' + currentQuantInstance.uomNG + '"^^xsd:string .');
                kb.add("bp:" + currentQuantInstance.quant_value_instNG + " gr:valueReference " + "bp:" + currentQuantInstance.quant_value_typeNG + "ValueRange .");
                if (currentQuantInstance.isRangeNG == true) {
                    // int or float value subclass
                    if (currentQuantInstance.valueTypeNG == "integer") {
                        // Int value subclass
                        kb.add("bp:" + currentQuantInstance.quant_value_instNG + ' gr:hasMinValueInteger "' + currentQuantInstance.minValueNG + '"^^<http://www.w3.org/2001/XMLSchema#integer> .')
                            .add("bp:" + currentQuantInstance.quant_value_instNG + ' gr:hasMaxValueInteger "' + currentQuantInstance.maxValueNG + '"^^<http://www.w3.org/2001/XMLSchema#integer> .');
                    } else {
                        // Float value subclass
                        kb.add("bp:" + currentQuantInstance.quant_value_instNG + ' gr:hasMinValueFloat "' + currentQuantInstance.minValueNG + '"^^xsd:float .')
                            .add("bp:" + currentQuantInstance.quant_value_instNG + ' gr:hasMaxValueFloat "' + currentQuantInstance.maxValueNG + '"^^xsd:float .');
                    }
                } else {
                    // int or float value subclass
                    if (currentQuantInstance.valueTypeNG == "integer") {
                        // Int value subclass
                        kb.add("bp:" + "" + currentQuantInstance.quant_value_instNG + ' gr:hasValueInteger "' + currentQuantInstance.valueNG + '"^^<http://www.w3.org/2001/XMLSchema#integer> .')
                            .add("bp:" + currentQuantInstance.quant_value_instNG + ' gr:hasMinValueInteger "' + currentQuantInstance.valueNG + '"^^<http://www.w3.org/2001/XMLSchema#integer> .')
                            .add("bp:" + currentQuantInstance.quant_value_instNG + ' gr:hasMaxValueInteger "' + currentQuantInstance.valueNG + '"^^<http://www.w3.org/2001/XMLSchema#integer> .');
                    } else {
                        // Float value subclass

                        kb.add("bp:" + currentQuantInstance.quant_value_instNG + ' gr:hasValueFloat "' + currentQuantInstance.valueNG + '"^^xsd:float .')
                            .add("bp:" + currentQuantInstance.quant_value_instNG + ' gr:hasMinValueFloat "' + currentQuantInstance.valueNG + '"^^xsd:float .')
                            .add("bp:" + currentQuantInstance.quant_value_instNG + ' gr:hasMaxValueFloat "' + currentQuantInstance.valueNG + '"^^xsd:float .');
                    }
                }
            });
            return kb;
        }

        //output preparation
        function getSLsFromPanel(currentPanel) {

            var currentSLP = {};
            var prefix = 'sl';


            var qualitativeSL = [];
            currentSLP.qualitative = qualitativeSL;
            if (document.getElementById(prefix + "_qual_values")) {
                var qualValuesPanels = document.getElementById(prefix + "_qual_values").children;
                for (var i = 0; i < qualValuesPanels.length; i++) {
                    var qualValueType = qualValuesPanels[i].id.replace(prefix + "_", "");

                    var qualValue = document.getElementById(prefix + "_selectbox_" + qualValueType).value;
                    qualitativeSL.push({
                        type: qualValueType,
                        value: qualValue
                    });

                }
            }
            var quantitativeSL = [];
            currentSLP.quantitative = quantitativeSL;
            if (document.getElementById(prefix + "_quant_values")) {
                var quantValuePanels = document.getElementById(prefix + "_quant_values").children;
                for (var i = 0; i < quantValuePanels.length; i++) {
                    var quantValueType = quantValuePanels[i].children[0].children[0].textContent;
                    var localPrefix = prefix + "_" + quantValueType;
                    var idType = localPrefix + '_type';
                    var idInstance = localPrefix + '_instance';
                    var idInstanceDesc = localPrefix + '_instanceDesc';
                    var idUom = localPrefix + '_uom';
                    var idIsRange = localPrefix + '_isRange';
                    var idValueType = localPrefix + '_valueType';
                    var idMinValue = localPrefix + '_minValue';
                    var idMaxValue = localPrefix + '_maxValue';
                    var idValue = localPrefix + '_value';


                    var quant_value_typeNG = document.getElementById(idType).textContent;
                    var quant_value_instNG = document.getElementById(idInstance).value;
                    var uomNG = document.getElementById(idUom).value;
                    var isRangeNG = document.getElementById(idIsRange).checked;
                    var minValueNG = document.getElementById(idMinValue).value;
                    var maxValueNG = document.getElementById(idMaxValue).value;
                    var valueNG = undefined;
                    if (!isRangeNG) {
                        valueNG = document.getElementById(idValue).value;
                    }
                    var valueTypeNG = document.getElementById(idValueType).value;
                    var instanceDescriptionNG = document.getElementById(idInstanceDesc).value;
                    quantitativeSL.push({
                        quant_value_typeNG: quant_value_typeNG,
                        quant_value_instNG: quant_value_instNG,
                        uomNG: uomNG,
                        isRangeNG: isRangeNG,
                        minValueNG: minValueNG,
                        maxValueNG: maxValueNG,
                        valueNG: valueNG,
                        valueTypeNG: valueTypeNG,
                        instanceDescriptionNG: instanceDescriptionNG
                    });
                }
            }
            return currentSLP;
        }

        function allowDrop(event) {
            event.preventDefault();
        }
        findBase = function (kb) {
            var base = kb.databank.baseURI;
            var services = kb.where("?brokerPolicy a ?serviceModel")
                .where("?serviceModel rdfs:subClassOf usdl-core:ServiceModel");

            services.each(function () {
                var selection_class = this["serviceModel"]
                var selection_instance = this["brokerPolicy"]

                var url_class = selection_class.value._string
                var url_instance = selection_instance.value._string
                base = url_class.split('#')[0]
                    // Assign the service model class and instance to the service description form
                document.getElementById("servicemodel_class").value = url_class.split('#')[1];
                document.getElementById("servicemodel").value = url_instance.split('#')[1];
                // window.alert(base);
            })

            return base
        }

        function addConcept() {
            var table = document.getElementById("class_table");
            var rowCount = table.rows.length;
            var row = table.insertRow(rowCount);
            var cell1 = row.insertCell(0);
            //var element1 = document.createElement("input");
            //element1.type = "checkbox";
            //element1.type = "chkbox[]";
            //cell1.appendChild(element1);
            cell1.className = 'col-sm-1';
            cell1.innerHTML = "<input type='checkbox'>";
            var cell2 = row.insertCell(1);
            cell2.innerHTML = rowCount + 1;
            cell2.className = 'col-sm-1';
            var cell3 = row.insertCell(2);
            var tax_class = document.getElementById("classtaxonomy").value;
            cell3.innerHTML = tax_class;
            cell3.className = 'col-sm-10';
        }

        function deleteConcept() {
            try {
                var table = document.getElementById("class_table");
                var rowCount = table.rows.length;
                for (var i = 0; i < rowCount; i++) {
                    var row = table.rows[i];
                    var chkbox = row.cells[0].childNodes[0];
                    if (null != chkbox && true == chkbox.checked) {
                        table.deleteRow(i);
                        rowCount--;
                        i--;
                    }
                }
            } catch (e) {
                alert(e);
            }
        }



        function addClassificationConcepts(kb) {
            var class_table = document.getElementById("class_table");
            for (i = 0; i < class_table.rows.length; i++) {
                kb.add("sd:" + document.getElementById("sd_model").value + " usdl-core-cb:hasClassificationDimension " + "<" + class_table.rows[i].cells[2].innerHTML + "> .")
            }
            return kb;
        }

        var elementUtil = {
            createTextBox: function (title, content, id) {
                var div = document.createElement('div');
                div.setAttribute('class', 'form-group');
                div.appendChild(function () {
                    var label = document.createElement('label');
                    label.htmlFor = id;
                    label.appendChild(document.createTextNode(title));
                    return label;
                });
                div.appendChild(function () {
                    var input = document.createElement('p');
                    input.id = id;
                    input.className('form-control-static');
                    input.appendChild(document.createTextNode(content));
                    return input;
                });
                return div;
            },

            createTextInputBox: function (title, content, id, readonly, descriptorSize, contentSize) {
                var div = document.createElement('div');
                div.setAttribute('class', 'form-group');
                div.appendChild(function () {
                    var label = document.createElement('label');
                    label.htmlFor = id;
                    label.className = 'col-sm-' + descriptorSize + ' control-label';
                    label.appendChild(document.createTextNode(title));
                    return label;
                }());
                div.appendChild(function () {
                    var innerDiv = document.createElement('div');
                    innerDiv.className = 'col-sm-' + contentSize;
                    innerDiv.appendChild(function () {
                        var input = document.createElement('input');
                        input.type = 'text';
                        input.id = id;
                        input.value = content;
                        input.className = 'form-control';
                        if (readonly) input.disabled = true;
                        return input;
                    }());
                    return innerDiv;
                }());
                return div;
            },
            createTextAreaBox: function (title, content, id, readonly, descriptorSize, contentSize) {
                var div = document.createElement('div');
                div.setAttribute('class', 'form-group');
                div.appendChild(function () {
                    var label = document.createElement('label');
                    label.htmlFor = id;
                    label.className = 'col-sm-' + descriptorSize + ' control-label';
                    label.appendChild(document.createTextNode(title));
                    return label;
                }());
                div.appendChild(function () {
                    var innerDiv = document.createElement('div');
                    innerDiv.className = 'col-sm-10';
                    innerDiv.appendChild(function () {
                        var input = document.createElement('textarea');
                        input.rows = 5;
                        input.id = id;
                        input.value = content;
                        input.className = 'form-control col-sm-' + contentSize;
                        if (readonly) input.disabled = true;
                        return input;
                    }());
                    return innerDiv;
                }());
                return div;
            },
            createCheckBox: function (title, check, id, descriptorSize, contentSize, enabled, onclickFunction) {
                var div = document.createElement('div');
                div.setAttribute('class', 'checkbox');
                div.appendChild(function () {
                    var label = document.createElement('label');

                    var checkbox = document.createElement('input');
                    checkbox.setAttribute("type", "checkbox");
                    checkbox.id = id;
                    checkbox.checked = check;
                    if (enabled) {
                        checkbox.disabled = false;
                    } else {
                        checkbox.disabled = true;
                    }
                    if (onclickFunction) checkbox.onclick = onclickFunction;
                    label.appendChild(checkbox);
                    label.appendChild(document.createTextNode(title));
                    return label;
                }());

                var outerDiv = document.createElement('div');
                outerDiv.className = 'col-sm-offset-' + descriptorSize + ' col-sm-' + contentSize;
                outerDiv.appendChild(div);
                return outerDiv;
            }

        }

        function createQuantitativeServiceLevelEditor(prefix, quantitativeDimensions, serviceLevels) {
            //quantitativeDimensions
            //format [{type: "AmmountOfCpu",  valueType: "float", uom: "", minValue: -1, maxValue: -1, isRange: false, higherIsBetter: false}, ...]

            var div = document.createElement('div');
            div.id = prefix + '_quant_values';

            quantitativeDimensions.forEach(function (qv) {
                var createFormForThisDimension = false;
                serviceLevels.forEach(function (sl) {
                    if (qv.type == sl) createFormForThisDimension = true;
                });
                if (createFormForThisDimension) {
                    var localPrefix = prefix + "_" + qv.type;
                    var panel = document.createElement('div');
                    panel.className = "panel panel-default panel2col";
                    panel.appendChild(function () {
                        var panelHeading = document.createElement('div');
                        panelHeading.className = 'panel-heading';

                        panelHeading.appendChild(function () {
                            var header = document.createElement('h2');
                            header.appendChild(document.createTextNode(qv.type));
                            header.id = localPrefix + '_type';
                            return header;
                        }());
                        return panelHeading;
                    }());

                    var form = document.createElement('form');
                    form.setAttribute('class', 'form-horizontal');
                    form.setAttribute('id', localPrefix + '_form');
                    form.appendChild(function () {
                        var paragraph = document.createElement('p');
                        paragraph.appendChild(document.createTextNode(qv.description));
                        return paragraph;
                    }());

                    form.appendChild(
                        elementUtil.createTextInputBox('Service Level', '', localPrefix + '_instance', false, 2, 10)
                    );
                    form.appendChild(
                        elementUtil.createTextInputBox('Service Level Description', '', localPrefix + '_instanceDesc', false, 2, 10)
                    );
                    form.appendChild(
                        elementUtil.createTextInputBox('Unit of Measurement', qv.uom, localPrefix + '_uom', true, 2, 10)
                    );
                    form.appendChild(
                        elementUtil.createTextInputBox('Value type', qv.valueType, localPrefix + '_valueType', true, 2, 10)
                    );
                    if (!qv.isRange) {
                        form.appendChild(
                            elementUtil.createTextInputBox('Min Value', qv.minValue, localPrefix + '_minValue', true, 2, 10)
                        );
                        form.appendChild(
                            elementUtil.createTextInputBox('Value', '', localPrefix + '_value', false, 2, 10)
                        );
                        form.appendChild(
                            elementUtil.createTextInputBox('Max Value', qv.maxValue, localPrefix + '_maxValue', true, 2, 10)
                        );
                    } else {
                        form.appendChild(
                            elementUtil.createTextInputBox('Min Value', qv.minValue, localPrefix + '_minValue', false, 2, 10)
                        );
                        form.appendChild(
                            elementUtil.createTextInputBox('Max Value', qv.maxValue, localPrefix + '_maxValue', false, 2, 10)
                        );
                    }
                    form.appendChild(elementUtil.createCheckBox('Is Range', qv.isRange, localPrefix + '_isRange', 2, 4));
                    form.appendChild(elementUtil.createCheckBox('Higher is Better', qv.higherIsBetter, localPrefix + '_higherIsBetter', 2, 4));



                    panel.appendChild(function () {
                        var panelBody = document.createElement('div');
                        panelBody.className = 'panel-body';
                        panelBody.id = localPrefix + '_panel-body';
                        panelBody.appendChild(form);
                        return panelBody;
                    }());
                    div.appendChild(panel);
                    //return panel;
                }
            });
            return div;
        }

        function createQualitativeServiceLevelEditor(prefix, qualitativeDimensions, serviceLevels) {
            //qualitativeDimensions:
            // format: [{value: "val", description: "desc", options: [{value: "optValue", description: "descr"},..]}..]
            var div = document.createElement('div');
            div.id = prefix + '_qual_values';
            //referenz zu loadQualitativeSLSchemasNG
            qualitativeDimensions.forEach(function (currentDimension) {
                var createFormForThisDimension = false;
                serviceLevels.forEach(function (sl) {
                    if (currentDimension.value == sl) createFormForThisDimension = true;
                });
                if (createFormForThisDimension) {
                    //create table
                    var qvTable = document.createElement('table');
                    qvTable.setAttribute('id', prefix + "_qual_values_" + currentDimension.value);
                    qvTable.setAttribute('style', 'width: 90%');
                    var qvHeader = qvTable.insertRow();
                    [{
                        content: 'Value',
                        class: 'col-sm-3'
                    }, {
                        content: 'Description',
                        class: 'col-sm-9'
                    }].forEach(function (descriptor) {
                        var headerCell = document.createElement('th');
                        if (descriptor.content) headerCell.appendChild(document.createTextNode(descriptor.content));
                        if (descriptor.class) headerCell.setAttribute('class', descriptor.class);
                        qvHeader.appendChild(headerCell);
                    });
                    //create selectbox
                    var selectbox = document.createElement("SELECT");
                    selectbox.setAttribute('id', prefix + '_selectbox_' + currentDimension.value);

                    currentDimension.options.forEach(function (currentOption) {
                        var qvRow = qvTable.insertRow();
                        var sl = document.createElement('input');
                        sl.setAttribute('type', 'text');
                        sl.setAttribute('value', currentOption.value);
                        sl.setAttribute('disabled', 'true');
                        qvRow.insertCell().appendChild(sl);
                        var slDesc = document.createElement('input');
                        slDesc.setAttribute('type', 'text');
                        slDesc.setAttribute('value', currentOption.description);
                        slDesc.setAttribute('disabled', 'true');
                        qvRow.insertCell().appendChild(slDesc);

                        var selectOption = document.createElement('option');
                        selectOption.setAttribute('value', currentOption.value);
                        selectOption.appendChild(document.createTextNode(currentOption.value));
                        selectbox.appendChild(selectOption);
                    });

                    var panel = document.createElement('div');
                    panel.className = 'panel panel-default';
                    panel.id = prefix + "_" + currentDimension.value;
                    var panelHeader = document.createElement('div');
                    panelHeader.className = 'panel-heading';
                    var header = document.createElement('H2');
                    header.appendChild(document.createTextNode(currentDimension.value));
                    panelHeader.appendChild(header);
                    var panelBody = document.createElement('div');
                    panelBody.className = 'panel-body';
                    panelBody.id = prefix + '_panel-body_' + currentDimension.value;
                    var descriptionNode = document.createElement('p');
                    descriptionNode.appendChild(document.createTextNode(currentDimension.description));
                    panelBody.appendChild(descriptionNode);
                    panelBody.appendChild(qvTable);
                    panelBody.appendChild(selectbox);
                    panel.appendChild(panelHeader);
                    panel.appendChild(panelBody);

                    div.appendChild(panel);
                }
            });
            //

            //und loadQualValuesNG
            return div;
        }

        function removeExistingQualAndQuantForms() {
            //todo
            var qual_val_div = document.getElementById('sl_qual_values');
            if (qual_val_div)
                document.getElementById('optionalInstancePanel').removeChild(qual_val_div);
            var quant_val_div = document.getElementById('sl_quant_values');
            if (quant_val_div)
                document.getElementById('optionalInstancePanel').removeChild(quant_val_div);
        }

        function addMissingServiceLevels(volatileServiceLevels) {
            var panel = document.getElementById('optionalInstances');

            if (volatileServiceLevels.length > 0) {
                var panelBody = document.getElementById('optionalInstancePanel');
                var prefix = 'sl';
                panelBody.appendChild(createQuantitativeServiceLevelEditor(prefix, document.serviceLevelDimensions.quantitative, volatileServiceLevels));
                panelBody.appendChild(createQualitativeServiceLevelEditor(prefix, document.serviceLevelDimensions.qualitative, volatileServiceLevels));
                panel.hidden = false;
            } else {
                panel.hidden = true;
            }
        }

        function setServiceLevels(url, prop) {
            //url: ServiceLevelProfile
            //prop: list of ServiceLevels
            //purpose select existing Service Level instances
            //Empty SL table
            var sl_table = document.getElementById("serviceleveldetails");
            //delete existing content
            while (sl_table.rows.length > 1) {
                sl_table.deleteRow(-1);
            }
            removeExistingQualAndQuantForms();
            var volatileServiceLevels = [];
            //Insert service levels into SL table
            for (i = 0; i < prop.length; i++) {
                var sl_prop = prop[i];
                //   window.alert (sl_prop);
                var sl = document.kb.where("<" + url + ">" + " <" + prop[i] + "> " + "?sl");
                if (sl.length == 0) {
                    //sl_prop is a Service Level without existing instance in BP
                    volatileServiceLevels.push(sl_prop.split('#hasSL')[1]);
                } else {
                    sl.each(function () {

                        var sel = this["sl"];
                        var sl_url = sel.value._string;
                        var value_instance_url = "";
                        var value_instance_label = "";
                        //var unit_of_measurement="";
                        // Find label of the value instance
                        var value_instance = document.kb.where("<" + sl_url + ">" + " ?sle_prop " + " ?sle")
                            .where("?sle_prop rdfs:subPropertyOf usdl-sla:hasServiceLevelExpression")
                            .where("?sle ?var_prop ?var")
                            .where("?var_prop rdfs:subPropertyOf usdl-sla:hasVariable")
                            .where("?var ?value_prop ?value")
                            .where("?value rdfs:label ?text");
                        //.where("?value gr:valueReference ?unit");
                        //.optional("?value_prop rdfs:subPropertyOf usdl-sla-cb:hasDefaultQualitativeValue");
                        value_instance.each(function () {
                            var sel_value_instance = this["value"];
                            value_instance_url = sel_value_instance.value._string;
                            var sel_label = this["text"];
                            value_instance_label = sel_label.value;
                            //var sel_unit = this["unit"];
                            //if (sel_unit === undefined) {window.alert("undefined!")} else
                            //{unit_of_measurement = sel_unit.value._string;}

                            //window.alert(var_url);
                        });
                        // Insert data into the table
                        var sl_table = document.getElementById("serviceleveldetails");
                        var new_row = sl_table.insertRow(-1);
                        var cell1 = new_row.insertCell(0);
                        var cell2 = new_row.insertCell(1);
                        var cell3 = new_row.insertCell(2);
                        //var cell4 = new_row.insertCell(3);
                        cell1.innerHTML = sl_url.split('#')[1];
                        cell2.innerHTML = value_instance_url.split('#')[1];
                        cell3.innerHTML = value_instance_label;
                        //cell4.innerHTML = "Unit of Measurement: " + unit_of_measurement;
                        // window.alert("event fired!");
                    });
                }
            }
            addMissingServiceLevels(volatileServiceLevels);
        }


        function loadServiceLevels() {
            var sl_property = document.kb.where("?prop rdfs:subPropertyOf usdl-sla:hasServiceLevel");
            var slp = document.getElementById("slp");
            var url = slp.value;
            var sl_prop_url = [];
            sl_property.each(function () {
                var selection = this["prop"];
                sl_prop_url[sl_prop_url.length] = selection.value._string;
            });
            setServiceLevels(url, sl_prop_url);
        }

        //load
        function loadBP(event) {
            event.preventDefault();
            var dt = event.dataTransfer
            var files = dt.files
            if (files.length == 1) {

                var reader = new FileReader();
                reader.onload = function (event) {
                    var content = event.target.result;
                    var kb = $.rdf();
                    kb.load(content);

                    kb.prefix('foaf', 'http://xmlns.com/foaf/0.1/')
                        .prefix('rdf', 'http://www.w3.org/1999/02/22-rdf-syntax-ns#')
                        .prefix('rdfs', 'http://www.w3.org/2000/01/rdf-schema#')
                        .prefix('owl', 'http://www.w3.org/2002/07/owl#')
                        .prefix('dcterms', 'http://purl.org/dc/terms/')
                        .prefix('usdl-core', 'http://www.linked-usdl.org/ns/usdl-core#')
                        .prefix('usdl-core-cb', 'http://www.linked-usdl.org/ns/usdl-core/cloud-broker#')
                        .prefix('usdl-sla', 'http://www.linked-usdl.org/ns/usdl-sla#')
                        .prefix('usdl-sla-cb', 'http://www.linked-usdl.org/ns/usdl-core/cloud-broker-sla#')
                        .prefix('usdl-business-roles', 'http://www.linked-usdl.org/ns/usdl-business-roles#')
                        .prefix('blueprint', 'http://bizweb.sap.com/TR/blueprint#')
                        .prefix('vcard', 'http://www.w3.org/2006/vcard/ns#')
                        .prefix('xsd', 'http://www.w3.org/2001/XMLSchema#')
                        .prefix('ctag', 'http://commontag.org/ns#')
                        .prefix('org', 'http://www.w3.org/ns/org#')
                        .prefix('skos', 'http://www.w3.org/2004/02/skos/core#')
                        .prefix('time', 'http://www.w3.org/2006/time#')
                        .prefix('gr', 'http://purl.org/goodrelations/v1#')
                        .prefix('doap', 'http://usefulinc.com/ns/doap#')
                        .base(findBase(kb) + "#");

                    kb.prefix('bp', kb.base());

                    var classconcepts = kb.where("?concept a usdl-core-cb:ClassificationDimension");

                    classconcepts.each(function () {
                        var selection = this["concept"];
                        var url = selection.value._string;
                        var selectelement = document.getElementById("classtaxonomy");
                        var concept = document.createElement("option");
                        concept.value = url;
                        concept.text = url.split('#')[1];
                        selectelement.add(concept, null);

                    });

                    var slpclasses = kb.where("?slp a ?slps")
                        .where("?slps rdfs:subClassOf usdl-sla:ServiceLevelProfile");

                    slpclasses.each(function () {
                        var sel = this["slps"];
                        var url_slps = sel.value._string;
                        document.getElementById("slp_class").value = url_slps.split('#')[1];
                        var selection = this["slp"];
                        var url = selection.value._string;
                        var selectelement = document.getElementById("slp");
                        var slp = document.createElement("option");
                        slp.value = url;
                        slp.text = url.split('#')[1];
                        selectelement.add(slp, null);
                    });
                    //window.alert(kb.base());

                    document.kb = kb;
                    document.serviceLevelDimensions = extractServiceLevelDimensions(kb);
                    loadServiceLevels();

                }
                reader.readAsText(files[0]);
                document.getElementById("bp").innerHTML = "Broker policy loaded!";
                $("#serviceEditArea").collapse('toggle');
                $("#serviceLoadArea").collapse('toggle');

            }
        }

        function extractServiceLevelDimensions(kb) {
            //extract quantitative data
            var quantitativeStuff = [];
            var quant_serviceLevels_integer = kb.where("?qvc rdfs:subClassOf gr:QuantitativeValueInteger");
            quant_serviceLevels_integer.each(function () {
                var qv = {
                    valueType: "integer",
                    type: "",
                    uom: "",
                    minValue: -1,
                    maxValue: -1,
                    isRange: false,
                    higherIsBetter: false
                };
                var sls_url = this['qvc'].value._string;
                qv.type = sls_url.split("#")[1];
                //Label
                var label = kb.where("<" + sls_url + ">" + " rdfs:label ?label");
                label.each(function () {
                    qv.description = this["label"].value;
                });
                // uom
                var uom = kb.where("<" + sls_url + ">" + " gr:hasUnitOfMeasurement ?uom");
                uom.each(function () {
                    qv.uom = this["uom"].value;
                });
                // minvalue
                var minv = kb.where("<" + sls_url + ">" + " gr:hasMinValueInteger ?minv");
                minv.each(function () {
                    qv.minValue = this["minv"].value;
                });
                // maxValue
                var maxv = kb.where("<" + sls_url + ">" + " gr:hasMaxValueInteger ?maxv");
                maxv.each(function () {
                    qv.maxValue = this["maxv"].value;
                });
                //range
                var range = kb.where("<" + sls_url + ">" + " usdl-core-cb:isRange ?range");
                range.each(function () {
                    qv.isRange = this["range"].value;
                });
                //higher is better
                var hib = kb.where("<" + sls_url + ">" + " usdl-core-cb:higherIsBetter ?hib");
                hib.each(function () {
                    qv.higherIsBetter = this["hib"].value;
                });
                quantitativeStuff.push(qv);
            });

            var quant_serviceLevels_float = kb.where("?qvc rdfs:subClassOf gr:QuantitativeValueFloat");
            quant_serviceLevels_float.each(function () {
                var qv = {
                    valueType: "float",
                    type: "",
                    uom: "",
                    minValue: -1,
                    maxValue: -1,
                    isRange: false,
                    higherIsBetter: false
                };
                var sls_url = this['qvc'].value._string;
                qv.type = sls_url.split("#")[1];
                //Label
                var label = kb.where("<" + sls_url + ">" + " rdfs:label ?label");
                label.each(function () {
                    qv.description = this["label"].value;
                });
                // uom
                var uom = kb.where("<" + sls_url + ">" + " gr:hasUnitOfMeasurement ?uom");
                uom.each(function () {
                    qv.uom = this["uom"].value;
                });
                // minvalue
                var minv = kb.where("<" + sls_url + ">" + " gr:hasMinValueFloat ?minv");
                minv.each(function () {
                    qv.minValue = this["minv"].value;
                });
                // maxValue
                var maxv = kb.where("<" + sls_url + ">" + " gr:hasMaxValueFloat ?maxv");
                maxv.each(function () {
                    qv.maxValue = this["maxv"].value;
                });
                //range
                var range = kb.where("<" + sls_url + ">" + " usdl-core-cb:isRange ?range");
                range.each(function () {
                    qv.isRange = this["range"].value;
                });
                //higher is better
                var hib = kb.where("<" + sls_url + ">" + " usdl-core-cb:higherIsBetter ?hib");
                hib.each(function () {
                    qv.higherIsBetter = this["hib"].value;
                });
                quantitativeStuff.push(qv);
            });


            //extract qualitative data
            var qualitativeStuff = [];
            // format: [{value: "val", description: "desc", options: [{value: "optValue", description: "descr"},..]}..]
            var qual_sls = kb.where("?qvc rdfs:subClassOf gr:QualitativeValue");
            qual_sls.each(function () {
                var qv_options = [];

                var selection = this["qvc"];
                var sls_url = selection.value._string;
                //serviceLevel
                var serviceLevel = sls_url.split("#")[1];
                //serviceLevel Discription
                var serviceLevelDescription = '';
                var label = kb.where("<" + sls_url + ">" + " rdfs:label ?label");
                label.each(function () {
                    serviceLevelDescription = this["label"].value;
                });

                var serviceLevelValues = kb.where("?valinst a bp:" + serviceLevel + "");
                serviceLevelValues.each(function () {
                    var valueInstance = this["valinst"];
                    var qv_url = valueInstance.value._string;
                    var qv_value = qv_url.split('#')[1];

                    var qv_description = '';
                    var label = kb.where("<" + qv_url + ">" + " rdfs:label ?label");
                    label.each(function () {
                        qv_description = this["label"].value;
                    });
                    qv_options.push({
                        value: qv_value,
                        description: qv_description
                    });
                });
                qualitativeStuff.push({
                    value: serviceLevel,
                    description: serviceLevelDescription,
                    options: qv_options
                });
            });

            return {
                quantitative: quantitativeStuff,
                qualitative: qualitativeStuff
            };
        }
    </script>
</head>

<body style="background-color: lightsilver">
    <div class="jumbotron">
        <div class="container">
            <div class="col-md-3">
                <a href="http://www.broker-cloud.eu/">
                    <img src="images/BrokerAtCloud_medium.png" alt="Broker@Cloud Logo" style="width:100%">
                </a>
            </div>
            <div class="col-md-9">
                <h1>Welcome to the Broker@Cloud Service Description Editor Type 2</h1>
                <p>This editor can be used to create Service Descriptions based on Broker Policies with instanciated profiles.</p>
            </div>
        </div>
    </div>
    <div class="container" role="main">
        <div id="serviceLoadArea" class="collapse in">
            <p>Note: The service description editor has to be configured with a valid broker policy before using.</p>
            <h1> Use drag and drop functionality to load the file containing the broker policy!</h1>

            <div class="droptarget" ondrop="loadBP(event)" ondragover="allowDrop(event)">
                <p id="bp"> Drop your broker policy here! </p>
            </div>
        </div>

        <div id="serviceEditArea" class="collapse">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h1> Specify your namespace </h1>
                </div>
                <div class="panel-body">
                    <!--p> Specify your broker namespace </p-->
                    <form>
                        <div class="form-group">
                            <label>Provider Namespace</label>
                            <input type="text" class="form-control" id="sp_namespace" value="http://yourprovidernamespace.com">
                        </div>
                    </form>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h1>Describe your legal business entity </h1>
                </div>
                <div class="panel-body">
                    <form>
                        <div class="form-group">
                            <label>Provider acronym</label>
                            <input class="form-control" type="text" id="sp_business_entity" value="YourCompanyAcronym">
                        </div>
                        <div class="form-group">
                            <label>Provider legal name</label>
                            <input class="form-control" type="text" id="sp_legal_name" value="Your Company Legal Name">
                        </div>
                    </form>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h1>Describe your service</h1></div>
                <div class="panel-body">
                    <form>
                        <div class="form-group">
                            <label>Service description namespace</label>
                            <input class="form-control" type="text" id="sd_namespace" value="http://yourservicenamespace.com">
                            <input type="text" id="servicemodel_class" value="Broker Policy Class" disabled="disabled" hidden="hidden">
                        </div>
                        <div class="form-group">
                            <label>Title</label>
                            <input class="form-control" type="text" id="sd" value="YourServiceDescriptionTitle">
                            <input type="text" id="servicemodel_class" value="Broker Policy Class" disabled="disabled" hidden="hidden">
                        </div>
                        <div class="form-group">
                            <label>Service model name</label>
                            <input class="form-control" type="text" id="sd_model" value="YourServiceModelName">
                            <input type="text" id="servicemodel" value="Broker Policy Instance" disabled="disabled" hidden="hidden">
                        </div>
                        <div class="form-group">
                            <label>Valid From</label>
                            <input class="form-control" type="text" id="sd_validFrom" value="2017-02-01">
                        </div>
                        <div class="form-group">
                            <label>Valid Through</label>
                            <input class="form-control" type="text" id="sd_validThrough" value="2017-02-28">
                        </div>
                                                                   <div class="form-group">
                                                <label>Successor of (URI to the predecessor service description, optional)</label>
                                                
                                                    <input class="form-control" type="text" id="sd_successorOf" value="">
                                                
                                            </div>
                                            <div class="form-group">
                                                <label>Recommendation deprecated from (optional)</label>
                                                
                                                    <input class="form-control" type="text" id="sd_deprecationRecommendation" value="YYYY-MM-DD">
                                                
                                            </div>
 
                        <div class="form-group">
                            <label>Depends on</label>
                            <input class="form-control" type="text" id="sd_dependsOn">
                        </div>
                    </form>
                </div>
            </div>

            <div class="panel panel-default">
                <div class="panel-heading">
                    <h1>Classify your service</h1></div>
                <div class="panel-body">
                    <b>Available service classification concepts:</b>
                    <select name="classifications" id="classtaxonomy"> </select>
                    <button class="btn btn-default" onclick="addConcept()"> Add </button>
                    <button class="btn btn-default" onclick="deleteConcept()"> Delete </button>

                    <div class='col-sm-12'>
                        <table class='table' id="class_table">

                        </table>
                    </div>
                </div>
            </div>


            <div class="panel panel-default">
                <div class="panel-heading">
                    <h1>Select a Service Level Profile applicable to your service </h1>
                </div>
                <div class="panel-body">

                    <input type="text" id="slp_class" value="SomeServiceLevelProfile" disabled="disabled" hidden="hidden">
                    <select name="servicelevelprofiles" id="slp" onchange="loadServiceLevels()"> </select>


                    <table class='table' style="width: 80%" id="serviceleveldetails">
                        <tr>
                            <th>Service Level</th>
                            <th>Value</th>
                            <th>Value Label</th>
                        </tr>
                    </table>
                    <div class="panel panel-default panel1col" id="optionalInstances" hidden=true>
                        <div class="panel-heading">
                            <h1>Specify additional Service Levels</h1>
                        </div>
                        <div class="panel-body" id="optionalInstancePanel">
                        </div>
                    </div>
                </div>
            </div>
            <p>
                <button class="btn btn-default" onclick="storeSD()">Show the service description specification. </button>
            </p>
        </div>
    </div>
</body>




</html>